<!-- ============ Script 1：只负责“计算器 + 解锁 + 弹窗 + 一键伪装” ============ -->
<script>
  window.addEventListener("DOMContentLoaded", function () {
    // 调试：确认脚本真的运行了
    console.log("计算器脚本已加载");

    var PIN_KEY = "secret_pin";

    var gateDisplayEl = document.getElementById("gateDisplay");
    var gateInfoEl = document.getElementById("gateInfo");
    var feedbackMask = document.getElementById("feedbackMask");
    var feedbackText = document.getElementById("feedbackText");
    var feedbackCancel = document.getElementById("feedbackCancel");
    var feedbackSubmit = document.getElementById("feedbackSubmit");
    var fakeLockBtn = document.getElementById("btnFakeLock");

    var gateView = document.getElementById("gateView");
    var appView = document.getElementById("appView");
    var mainTitle = document.getElementById("mainTitle");

    var calcDisplay = "0";
    var calcExpr = "";
    var calcInfo = "";
    var secretModeActive = false;
    var secretEqualCount = 0;

    function renderCalc() {
      if (gateDisplayEl) gateDisplayEl.textContent = calcDisplay;
      if (gateInfoEl) gateInfoEl.textContent = calcInfo || "";
    }

    function resetSecret() {
      secretModeActive = false;
      secretEqualCount = 0;
    }

    function onClear() {
      calcDisplay = "0";
      calcExpr = "";
      calcInfo = "";
      resetSecret();
      renderCalc();
    }

    function onDigit(d) {
      if (calcDisplay === "0" || calcDisplay === "错误" || calcDisplay === "完成") {
        calcDisplay = d;
      } else {
        calcDisplay += d;
      }
      calcExpr += d;
      calcInfo = "";
      resetSecret();
      renderCalc();
    }

    function onOp(op) {
      if (!calcExpr) return;
      var last = calcExpr.charAt(calcExpr.length - 1);
      if ("+-×÷".indexOf(last) !== -1) {
        calcExpr = calcExpr.slice(0, -1) + op;
      } else {
        calcExpr += op;
      }
      calcDisplay = calcExpr;
      calcInfo = "";
      resetSecret();
      renderCalc();
    }

    function evalExpressionSimple(expr) {
      if (!expr || !expr.trim()) return "0";
      var cleaned = expr.replace(/ /g, "");
      var nums = [];
      var ops = [];
      var current = "";

      for (var i = 0; i < cleaned.length; i++) {
        var ch = cleaned.charAt(i);
        if ((ch >= "0" && ch <= "9") || ch === ".") {
          current += ch;
        } else if ("+-×÷".indexOf(ch) !== -1) {
          if (!current) return null;
          var v = Number(current);
          if (!isFinite(v)) return null;
          nums.push(v);
          ops.push(ch);
          current = "";
        } else {
          return null;
        }
      }
      if (current) {
        var v2 = Number(current);
        if (!isFinite(v2)) return null;
        nums.push(v2);
      }
      if (!nums.length) return null;

      var result = nums[0];
      for (var j = 0; j < ops.length; j++) {
        var b = nums[j + 1];
        if (typeof b === "undefined") return null;
        var op2 = ops[j];
        if (op2 === "+") result += b;
        else if (op2 === "-") result -= b;
        else if (op2 === "×") result *= b;
        else if (op2 === "÷") {
          if (b === 0) return null;
          result /= b;
        }
      }
      var asLong = Math.trunc(result);
      return result === asLong ? String(asLong) : String(result);
    }

    function showApp() {
      if (gateView) gateView.style.display = "none";
      if (appView) appView.style.display = "block";
      if (mainTitle) mainTitle.style.display = "block";
    }

    // 一键伪装：回到计算器初始状态
    function fakeLock() {
      if (appView) appView.style.display = "none";
      if (mainTitle) mainTitle.style.display = "none";
      if (gateView) gateView.style.display = "block";

      calcDisplay = "0";
      calcExpr = "";
      calcInfo = "";
      resetSecret();
      renderCalc();
    }

    function openFeedbackDialog() {
      if (!feedbackMask || !feedbackText) return;
      feedbackText.value = "";
      feedbackMask.style.display = "flex";
    }

    function closeFeedbackDialog() {
      if (!feedbackMask) return;
      feedbackMask.style.display = "none";
    }

    if (feedbackCancel) {
      feedbackCancel.addEventListener("click", function () {
        closeFeedbackDialog();
      });
    }

    if (feedbackSubmit) {
      feedbackSubmit.addEventListener("click", function () {
        if (!feedbackText) {
          closeFeedbackDialog();
          return;
        }
        var trimmed = feedbackText.value.replace(/^\s+|\s+$/g, "");
        var isDigitsOnly = trimmed.length > 0 && /^[0-9]+$/.test(trimmed);

        if (isDigitsOnly) {
          try {
            window.localStorage.setItem(PIN_KEY, trimmed);
          } catch (e) {}
          calcInfo = "反馈已提交。";
        } else {
          calcInfo = "反馈已提交。";
        }
        renderCalc();
        closeFeedbackDialog();
      });
    }

    function onEqual() {
      var exprBefore = calcExpr;
      var currentPin = null;
      try {
        currentPin = window.localStorage.getItem(PIN_KEY);
      } catch (e) {}

      // 1) 解锁
      if (currentPin && exprBefore === currentPin) {
        calcDisplay = "完成";
        calcInfo = "已解锁";
        calcExpr = "";
        resetSecret();
        renderCalc();
        showApp();
        return;
      }

      // 2) 隐藏入口：1+1 + 连续按 20 次 "="
      if (!secretModeActive) {
        if (exprBefore === "1+1") {
          secretModeActive = true;
          secretEqualCount = 1;
        }
      } else {
        secretEqualCount += 1;
      }

      if (secretModeActive && secretEqualCount >= 20) {
        openFeedbackDialog();
        resetSecret();
      }

      // 3) 正常计算
      var res = evalExpressionSimple(exprBefore);
      if (res !== null) {
        calcDisplay = res;
        calcExpr = res;
        calcInfo = "";
      } else {
        calcDisplay = "错误";
        calcInfo = "无效表达式";
      }
      renderCalc();
    }

    // === 关键：统一事件委托，任何 .calc-btn 点击都能被捕获 ===
    document.addEventListener("click", function (e) {
      var btn = e。target。closest(".calc-btn");
      if (!btn) return;

      var type = btn.getAttribute("data-type");
      var val = btn。getAttribute("data-val") || "";

      console.log("点击按钮:", type, val); // 调试用，看控制台

      if (type === "digit") onDigit(val);
      else if (type === "op") onOp(val);
      else if (type === "clear") onClear();
      else if (type === "equal") onEqual();
    });

    // 一键伪装按钮
    if (fakeLockBtn) {
      fakeLockBtn.addEventListener("click", function (e) {
        e.preventDefault();
        fakeLock();
      });
    }

    renderCalc();
  });
</script>
